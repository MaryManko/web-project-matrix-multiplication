<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Система Розподілених Обчислень</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 50px; background-color: #f0f2f5; }
        .container { max-width: 800px; }
        .card { border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .hidden { display: none !important; }
        .auth-container { max-width: 400px; margin: 0 auto; }
    </style>
</head>
<body>

<div class="container">
    <h1 class="text-center mb-4 fw-bold text-primary">High-Load System</h1>

    <div id="authSection" class="auth-container">
        
        <ul class="nav nav-pills nav-fill mb-3" id="pills-tab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="login-tab" data-bs-toggle="pill" data-bs-target="#login-form" type="button">Вхід</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="register-tab" data-bs-toggle="pill" data-bs-target="#register-form" type="button">Реєстрація</button>
            </li>
        </ul>

        <div class="card p-4">
            <div class="tab-content">
                <div class="tab-pane fade show active" id="login-form">
                    <form onsubmit="handleLogin(event)">
                        <div class="mb-3">
                            <label>Email</label>
                            <input type="email" id="loginEmail" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label>Пароль</label>
                            <input type="password" id="loginPass" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Увійти</button>
                    </form>
                </div>

                <div class="tab-pane fade" id="register-form">
                    <form onsubmit="handleRegister(event)">
                        <div class="mb-3">
                            <label>Email</label>
                            <input type="email" id="regEmail" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label>Пароль</label>
                            <input type="password" id="regPass" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Зареєструватися</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="appSection" class="hidden">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 id="userEmailLabel" class="text-muted"></h4>
            <button onclick="logout()" class="btn btn-outline-danger btn-sm">Вийти</button>
        </div>

        <div class="card p-4">
            <div class="row g-2 align-items-center">
                <div class="col-auto"><label class="col-form-label">Розмір матриці:</label></div>
                <div class="col"><input type="number" id="matrixSize" class="form-control" placeholder="100-2000"></div>
                <div class="col-auto"><button onclick="createTask()" class="btn btn-primary">Запустити</button></div>
            </div>
        </div>

        <h3 class="mt-4">Мої Задачі</h3>
        <div class="card p-3">
            <table class="table table-hover align-middle">
                <thead>
                    <tr><th>ID</th><th>Опис</th><th>Статус</th><th>Прогрес</th><th>Дія</th></tr>
                </thead>
                <tbody id="tasksTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const API_URL = "";
    let TOKEN = localStorage.getItem("access_token");

    function checkAuth() {
        if (TOKEN) {
            document.getElementById("authSection").classList.add("hidden");
            document.getElementById("appSection").classList.remove("hidden");
            loadTasks();
            try {
                const payload = JSON.parse(atob(TOKEN.split('.')[1]));
                document.getElementById("userEmailLabel").innerText = "Ви увійшли як: " + payload.sub;
            } catch(e) {}
        } else {
            document.getElementById("authSection").classList.remove("hidden");
            document.getElementById("appSection").classList.add("hidden");
        }
    }

    async function handleLogin(e) {
        e.preventDefault();
        const email = document.getElementById("loginEmail").value;
        const pass = document.getElementById("loginPass").value;
        const formData = new URLSearchParams();
        formData.append('username', email);
        formData.append('password', pass);

        try {
            const response = await fetch(API_URL + "/login", {
                method: "POST",
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: formData
            });

            if (!response.ok) { alert("Невірний логін або пароль!"); return; }
            const data = await response.json();
            TOKEN = data.access_token;
            localStorage.setItem("access_token", TOKEN);
            checkAuth();
        } catch (err) { alert("Помилка входу"); }
    }

    async function handleRegister(e) {
        e.preventDefault();
        const email = document.getElementById("regEmail").value;
        const pass = document.getElementById("regPass").value;

        try {
            const response = await fetch(API_URL + "/register", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ email: email, password: pass })
            });

            if (!response.ok) {
                const err = await response.json();
                alert("Помилка: " + err.detail);
                return;
            }
            alert("Успішно! Тепер увійдіть.");
            document.getElementById("login-tab").click();
        } catch (err) { alert("Помилка реєстрації"); }
    }

    function logout() {
        localStorage.removeItem("access_token");
        TOKEN = null;
        checkAuth();
    }

    async function loadTasks() {
        if (!TOKEN) return;
        try {
            const response = await fetch(API_URL + "/tasks", {
                headers: { "Authorization": "Bearer " + TOKEN }
            });
            if (response.status === 401) { logout(); return; }
            
            const tasks = await response.json();
            const tbody = document.getElementById('tasksTableBody');
            tbody.innerHTML = ''; 

            tasks.forEach(task => {
                let badge = task.status === 'Completed' ? 'bg-success' : 
                            task.status === 'Processing' ? 'bg-warning text-dark' : 
                            task.status === 'Error' ? 'bg-danger' : 'bg-secondary';
                
                let btn = (task.status === 'Processing' || task.status === 'Pending') 
                    ? `<button onclick="cancelTask(${task.id})" class="btn btn-danger btn-sm">Стоп</button>` : '';

                tbody.innerHTML += `
                    <tr><td>${task.id}</td><td>${task.description}</td><td><span class="badge ${badge}">${task.status}</span></td>
                    <td><div class="progress" style="height: 15px;"><div class="progress-bar ${badge}" style="width: ${task.progress}%">${task.progress}%</div></div></td>
                    <td>${btn}</td></tr>`;
            });
        } catch (e) { console.error(e); }
    }

async function createTask() {
    const sizeInput = document.getElementById('matrixSize').value;
    if (!sizeInput) return alert("Введіть розмір");

    const size = parseInt(sizeInput);

    if (size > 2000) {
        alert("Помилка: Розмір матриці не може перевищувати 2000!");
        return;
    }

    if (size < 2) {
        alert("Помилка: Матриця занадто мала!");
        return;
    }

    const response = await fetch(API_URL + "/tasks", {
        method: "POST",
        headers: { 
            "Content-Type": "application/json", 
            "Authorization": "Bearer " + TOKEN 
        },
        body: JSON.stringify({ matrix_size: size })
    });

    if (!response.ok) { 
        const err = await response.json(); 
        alert(err.detail); 
    } else { 
        loadTasks(); 
        document.getElementById('matrixSize').value = "";
    }
}

    async function cancelTask(id) {
        await fetch(API_URL + `/tasks/${id}/cancel`, {
            method: "POST",
            headers: { "Authorization": "Bearer " + TOKEN }
        });
        loadTasks();
    }

    setInterval(() => { if(TOKEN) loadTasks(); }, 2000);
    checkAuth();
</script>
</body>
</html>