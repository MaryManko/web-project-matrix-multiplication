<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ –†–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–∏—Ö –û–±—á–∏—Å–ª–µ–Ω—å</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 50px; background-color: #f8f9fa; }
        .container { max-width: 950px; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; }
        .btn-primary { background-color: #0d6efd; }
    </style>
</head>
<body>

<div class="container">
    <h1 class="text-center mb-5 fw-bold">–°–∏—Å—Ç–µ–º–∞ –†–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–∏—Ö –û–±—á–∏—Å–ª–µ–Ω—å</h1>

    <div class="card p-4">
        <div class="row g-3 align-items-center justify-content-center">
            <div class="col-auto">
                <label for="matrixSize" class="col-form-label fs-5">–†–æ–∑–º—ñ—Ä –º–∞—Ç—Ä–∏—Ü—ñ:</label>
            </div>
            <div class="col-auto">
                <input type="number" id="matrixSize" class="form-control form-control-lg" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥, 100" style="width: 200px;">
            </div>
            <div class="col-auto">
                <button onclick="createTask()" class="btn btn-primary btn-lg">–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –æ–±—á–∏—Å–ª–µ–Ω–Ω—è</button>
            </div>
        </div>
    </div>

    <h3 class="mb-3">–Ü—Å—Ç–æ—Ä—ñ—è –ó–∞–¥–∞—á</h3>
    <div class="card p-3">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th style="width: 5%">ID</th>
                    <th style="width: 30%">–û–ø–∏—Å</th>
                    <th style="width: 15%">–°—Ç–∞—Ç—É—Å</th>
                    <th style="width: 35%">–ü—Ä–æ–≥—Ä–µ—Å</th>
                    <th style="width: 15%">–î—ñ—è</th>
                </tr>
            </thead>
            <tbody id="tasksTableBody">
                </tbody>
        </table>
    </div>
</div>

<script>
    // –ê–¥—Ä–µ—Å–∞ –Ω–∞—à–æ–≥–æ API (Nginx –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—î –ø–æ—Ä—Ç 80, —Ç–æ–º—É –ø–æ—Ä—Ç –Ω–µ –ø–∏—à–µ–º–æ)
    const API_URL = "http://127.0.0.1";

    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É –∑–∞–¥–∞—á
    async function loadTasks() {
        try {
            const response = await fetch(API_URL + "/tasks");
            if (!response.ok) return; // –Ø–∫—â–æ –ø–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ - —ñ–≥–Ω–æ—Ä—É—î–º–æ
            
            const tasks = await response.json();
            const tbody = document.getElementById('tasksTableBody');
            tbody.innerHTML = ''; // –û—á–∏—â–∞—î–º–æ —Ç–∞–±–ª–∏—Ü—é –ø–µ—Ä–µ–¥ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è–º

            tasks.forEach(task => {
                // –í–∏–±–∏—Ä–∞—î–º–æ –∫–æ–ª—ñ—Ä –¥–ª—è —Å—Ç–∞—Ç—É—Å—É
                let statusBadge = '';
                if (task.status === 'Completed') statusBadge = '<span class="badge bg-success">Completed</span>';
                else if (task.status === 'Processing') statusBadge = '<span class="badge bg-warning text-dark">Processing</span>';
                else if (task.status === 'Cancelled') statusBadge = '<span class="badge bg-dark">Cancelled</span>';
                else if (task.status === 'Error') statusBadge = '<span class="badge bg-danger">Error</span>';
                else statusBadge = `<span class="badge bg-secondary">${task.status}</span>`;

                // –ü–æ–∫–∞–∑—É—î–º–æ –∫–Ω–æ–ø–∫—É "–°—Ç–æ–ø" —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –∑–∞–¥–∞—á–∞ –∞–∫—Ç–∏–≤–Ω–∞
                let actionButton = '';
                if (task.status === 'Processing' || task.status === 'Pending') {
                    actionButton = `<button onclick="cancelTask(${task.id})" class="btn btn-danger btn-sm">–°—Ç–æ–ø üõë</button>`;
                }

                // –°—Ç–≤–æ—Ä—é—î–º–æ —Ä—è–¥–æ–∫ —Ç–∞–±–ª–∏—Ü—ñ
                const row = `
                    <tr>
                        <td><strong>${task.id}</strong></td>
                        <td>${task.description}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated ${task.status === 'Error' ? 'bg-danger' : ''}"
                                     role="progressbar"
                                     style="width: ${task.progress}%;"
                                     aria-valuenow="${task.progress}" aria-valuemin="0" aria-valuemax="100">
                                    ${task.progress}%
                                </div>
                            </div>
                        </td>
                        <td>${actionButton}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        } catch (error) {
            console.error("–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:", error);
        }
    }

    // –§—É–Ω–∫—Ü—ñ—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ—ó –∑–∞–¥–∞—á—ñ (–ó –í–ê–õ–Ü–î–ê–¶–Ü–Ñ–Æ –ü–û–ú–ò–õ–û–ö)
    async function createTask() {
        const sizeInput = document.getElementById('matrixSize');
        const size = parseInt(sizeInput.value);

        if (isNaN(size)) {
            alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å —á–∏—Å–ª–æ!");
            return;
        }

        try {
            const response = await fetch(API_URL + "/tasks", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ matrix_size: size })
            });

            // --- –ü–ï–†–ï–í–Ü–†–ö–ê –ù–ê –ü–û–ú–ò–õ–ö–ò –í–Ü–î –°–ï–†–í–ï–†–ê ---
            if (!response.ok) {
                // –Ø–∫—â–æ —Å–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω—É–≤ 400 –∞–±–æ 500
                const errorData = await response.json();
                // –ü–æ–∫–∞–∑—É—î–º–æ –∫—Ä–∞—Å–∏–≤–µ –≤—ñ–∫–æ–Ω—Ü–µ –∑ —Ç–µ–∫—Å—Ç–æ–º –ø–æ–º–∏–ª–∫–∏
                alert("‚ö†Ô∏è –ü–û–ú–ò–õ–ö–ê: " + errorData.detail);
                return; // –í–∏—Ö–æ–¥–∏–º–æ, –Ω–µ –æ–Ω–æ–≤–ª—é—î–º–æ —Ç–∞–±–ª–∏—Ü—é
            }
            // ----------------------------------------

            // –Ø–∫—â–æ –≤—Å–µ –æ–∫ - –æ–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫
            await loadTasks();
            sizeInput.value = ""; 
        } catch (error) {
            console.error("Error creating task:", error);
            alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑'—î–¥–Ω–∞—Ç–∏—Å—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º!");
        }
    }

    // –§—É–Ω–∫—Ü—ñ—è —Å–∫–∞—Å—É–≤–∞–Ω–Ω—è –∑–∞–¥–∞—á—ñ
    async function cancelTask(taskId) {
        if (!confirm("–ó—É–ø–∏–Ω–∏—Ç–∏ —Ü—é –∑–∞–¥–∞—á—É?")) return;
        
        try {
            await fetch(API_URL + `/tasks/${taskId}/cancel`, { method: "POST" });
            await loadTasks(); // –û–¥—Ä–∞–∑—É –æ–Ω–æ–≤–∏—Ç–∏ –≤–∏–≥–ª—è–¥
        } catch (error) {
            alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Å–∫–∞—Å—É–≤–∞–Ω–Ω—ñ");
        }
    }

    // –û–Ω–æ–≤–ª—é—î–º–æ –¥–∞–Ω—ñ –∫–æ–∂–Ω—ñ 2 —Å–µ–∫—É–Ω–¥–∏
    setInterval(loadTasks, 2000);
    
    // –ü–µ—Ä—à–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
    loadTasks();
</script>

</body>
</html>